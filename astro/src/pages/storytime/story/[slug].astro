---
/**
 * Dynamic Story Page
 * Generates a page for each published story at build time
 */
import StoryLayout from '../../../layouts/StoryLayout.astro';

const API_URL = import.meta.env.API_URL || 'https://aenrique.com';

// Generate static paths for all published stories
export async function getStaticPaths() {
  const API_URL = import.meta.env.API_URL || 'https://aenrique.com';
  
  try {
    const response = await fetch(`${API_URL}/api/stories/list.php`);
    if (!response.ok) return [];
    
    const data = await response.json();
    const stories = (data.data || data.stories || []).filter((s: any) => s.status === 'published');
    
    return stories.map((story: any) => ({
      params: { slug: story.slug },
      props: { story }
    }));
  } catch (e) {
    console.warn('Could not fetch stories for static paths:', e);
    return [];
  }
}

interface Props {
  story: any;
}

const { story } = Astro.props;

// Fetch chapters for this story
let chapters: any[] = [];
let authorName = 'Author';

try {
  const [chaptersRes, authorRes] = await Promise.all([
    fetch(`${API_URL}/api/chapters/list.php?story_id=${story.id}`),
    fetch(`${API_URL}/api/author/get.php`)
  ]);
  
  if (chaptersRes.ok) {
    const data = await chaptersRes.json();
    chapters = (data.data || data.chapters || []).filter((c: any) => c.status === 'published');
  }
  
  if (authorRes.ok) {
    const data = await authorRes.json();
    authorName = data.profile?.name || authorName;
  }
} catch (e) {
  console.warn('Could not fetch chapters:', e);
}

// Sort chapters by chapter number
chapters.sort((a, b) => (a.chapter_number || 0) - (b.chapter_number || 0));
---

<StoryLayout 
  title={`${story.title} | ${authorName}`}
  description={story.description}
  image={story.cover_image}
  type="book"
  storyTitle={story.title}
>
  <article>
    <!-- Story Header -->
    <header class="mb-8">
      <div class="flex flex-col sm:flex-row gap-6">
        {story.cover_image && (
          <img 
            src={story.cover_image} 
            alt={story.title}
            class="w-40 h-56 object-cover rounded-xl shadow-2xl mx-auto sm:mx-0"
          />
        )}
        <div class="text-center sm:text-left">
          <h1 class="text-3xl md:text-4xl font-bold text-white">{story.title}</h1>
          {story.tagline && (
            <p class="text-lg brand-text mt-2">{story.tagline}</p>
          )}
          <p class="text-neutral-300 mt-4">{story.description}</p>
          
          {story.genres && story.genres.length > 0 && (
            <div class="flex flex-wrap gap-2 mt-4 justify-center sm:justify-start">
              {story.genres.map((genre: string) => (
                <span class="text-xs px-3 py-1 rounded-full bg-white/10 text-neutral-300">
                  {genre}
                </span>
              ))}
            </div>
          )}

          {story.external_links && story.external_links.length > 0 && (
            <div class="flex flex-wrap gap-3 mt-4 justify-center sm:justify-start">
              {story.external_links.map((link: any) => (
                <a 
                  href={link.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors"
                >
                  {link.label}
                </a>
              ))}
            </div>
          )}
        </div>
      </div>
    </header>

    <!-- Chapters List -->
    <section>
      <h2 class="text-2xl font-bold text-white mb-4">
        Chapters ({chapters.length})
      </h2>
      
      {chapters.length === 0 ? (
        <p class="text-neutral-400">No chapters published yet.</p>
      ) : (
        <ol class="space-y-2">
          {chapters.map((chapter) => (
            <li>
              <a 
                href={`/storytime/story/${story.slug}/${chapter.slug}`}
                class="flex items-center gap-3 p-4 rounded-xl bg-neutral-900/50 border border-white/10 hover:border-white/20 hover:bg-neutral-900/70 transition-colors group"
              >
                <span class="text-sm text-neutral-500 w-16 flex-shrink-0">
                  Ch. {chapter.chapter_number}
                </span>
                <span class="text-white group-hover:brand-text transition-colors flex-1">
                  {chapter.title}
                </span>
                {chapter.word_count && (
                  <span class="text-xs text-neutral-500">
                    {Math.round(chapter.word_count / 1000)}k words
                  </span>
                )}
              </a>
            </li>
          ))}
        </ol>
      )}

      {chapters.length > 0 && (
        <div class="mt-6">
          <a 
            href={`/storytime/story/${story.slug}/${chapters[0].slug}`}
            class="inline-block px-6 py-3 brand-bg text-white font-semibold rounded-lg hover:opacity-90 transition-opacity"
          >
            Start Reading Chapter 1 â†’
          </a>
        </div>
      )}
    </section>
  </article>
</StoryLayout>
