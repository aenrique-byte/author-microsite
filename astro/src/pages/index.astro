---
/**
 * Homepage - Fetches data from PHP/MySQL API at build time
 */
import BaseLayout from '../layouts/BaseLayout.astro';

const API_URL = import.meta.env.API_URL || 'https://aenrique.com';

// Fetch homepage data at build time
let homepageData = null;
let error = null;

try {
  const response = await fetch(`${API_URL}/api/homepage/get.php`);
  if (response.ok) {
    homepageData = await response.json();
  } else {
    error = `API returned ${response.status}`;
  }
} catch (e) {
  error = String(e);
}

// Destructure with fallbacks
const profile = homepageData?.profile || { name: 'Author', tagline: 'Writer' };
const settings = homepageData?.settings || {};
const stories = homepageData?.stories || [];
const featured_story = homepageData?.featured_story;
const activity = homepageData?.activity || [];
const tools = homepageData?.tools || [];
const socials = homepageData?.socials || {};

const brandColor = settings.brand_color_dark || '#10b981';

// Helper to ensure image URLs are absolute
function absoluteUrl(url: string | undefined): string {
  if (!url) return '';
  if (url.startsWith('http://') || url.startsWith('https://')) return url;
  if (url.startsWith('/')) return `${API_URL}${url}`;
  return `${API_URL}/${url}`;
}
---

<BaseLayout 
  title={`${profile.name} | ${profile.tagline || settings.hero_tagline}`}
  description={settings.hero_description || profile.bio}
  image={profile.profile_image}
  brandColor={brandColor}
>
  <div class="relative min-h-screen">
    <!-- Background -->
    <div 
      class="fixed inset-0 z-0 bg-cover bg-center bg-no-repeat"
      style={`background-image: url('${absoluteUrl(profile.background_image_dark) || '/images/lofi_bg.webp'}'); background-color: #0a0a0a;`}
    ></div>
    <div class="fixed inset-0 z-[1] bg-black/40 pointer-events-none"></div>

    <!-- Page Content -->
    <div class="relative z-10 max-w-6xl mx-auto px-4 pb-24">
      
      <!-- Navbar -->
      <header class="flex items-center justify-between py-6">
        <a href="/" class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-full brand-bg flex items-center justify-center text-sm font-black text-white">
            {profile.name?.slice(0, 2).toUpperCase() || 'OW'}
          </div>
          <div>
            <div class="text-sm font-semibold tracking-wide uppercase brand-text">
              {profile.name}
            </div>
            <div class="text-xs text-neutral-100">
              {profile.tagline || settings.hero_tagline}
            </div>
          </div>
        </a>

        <nav class="hidden md:flex items-center gap-6 text-sm font-medium">
          <a href="/storytime" class="text-neutral-100 hover:text-white transition-colors">Stories</a>
          <a href="/blog" class="text-neutral-100 hover:text-white transition-colors">Blog</a>
          <a href="/galleries" class="text-neutral-100 hover:text-white transition-colors">Galleries</a>
          {settings.newsletter_url && (
            <a
              href={settings.newsletter_url}
              target="_blank"
              rel="noopener noreferrer"
              class="rounded-full brand-bg px-4 py-1.5 text-sm font-semibold text-white hover:opacity-90 transition-opacity"
            >
              Subscribe
            </a>
          )}
        </nav>
      </header>

      <!-- Hero Section -->
      <section class="grid gap-10 md:grid-cols-[minmax(0,3fr)_minmax(0,2fr)] items-center pt-8 md:pt-16">
        <div>
          <p class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-medium uppercase tracking-[0.2em] brand-text border border-white/10">
            {settings.hero_tagline || 'Author'}
          </p>
          <h1 class="mt-5 text-4xl md:text-5xl lg:text-6xl font-extrabold tracking-tight">
            {settings.hero_title || 'Welcome'}
            <span class="block brand-text">{profile.name}</span>
          </h1>
          <p class="mt-4 text-neutral-100 text-base md:text-lg max-w-xl">
            {settings.hero_description || profile.bio}
          </p>

          <div class="mt-8 flex flex-wrap gap-4">
            <a
              href="/storytime"
              class="rounded-lg brand-bg px-6 py-3 text-sm font-semibold text-white shadow-lg hover:opacity-90 transition-opacity"
            >
              Start Reading
            </a>
            <a
              href="/galleries"
              class="rounded-lg border border-white/20 bg-white/5 px-6 py-3 text-sm font-semibold text-white hover:bg-white/10 transition-colors"
            >
              Browse Galleries
            </a>
          </div>

          {(socials.royalroad || socials.patreon) && (
            <div class="mt-6 flex flex-wrap items-center gap-4 text-xs text-neutral-200">
              {socials.royalroad && (
                <a href={socials.royalroad} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 hover:opacity-80">
                  <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-400 text-xs font-bold">
                    RR
                  </span>
                  Live on RoyalRoad
                </a>
              )}
              {socials.patreon && (
                <a href={socials.patreon} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 hover:opacity-80">
                  <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-pink-500/20 text-pink-400 text-xs font-bold">
                    ✦
                  </span>
                  Early chapters on Patreon
                </a>
              )}
            </div>
          )}
        </div>

        <!-- Featured Story Card -->
        {settings.show_featured_story && featured_story && (
          <div class="rounded-3xl bg-neutral-900/30 border border-white/10 backdrop-blur-xl shadow-2xl p-6 md:p-7 flex flex-col gap-4">
            <div class="text-xs font-semibold uppercase tracking-[0.22em] text-neutral-400">
              Featured Universe
            </div>
            <div class="flex flex-col gap-4 sm:flex-row">
              {featured_story.cover_image && (
                <a href={`/storytime/story/${featured_story.slug}`} class="relative h-40 w-28 flex-shrink-0 rounded-xl overflow-hidden shadow-lg">
                  <img 
                    src={absoluteUrl(featured_story.cover_image)} 
                    alt={featured_story.title} 
                    class="h-full w-full object-cover hover:scale-[1.03] transition-transform duration-200"
                    loading="lazy"
                  />
                </a>
              )}
              <div class="flex-1">
                <h2 class="text-xl font-bold text-white mb-1">{featured_story.title}</h2>
                {featured_story.tagline && <p class="text-xs font-medium brand-text mb-2">{featured_story.tagline}</p>}
                <p class="text-sm text-neutral-100">{featured_story.homepage_description || featured_story.description}</p>
                {featured_story.genres && featured_story.genres.length > 0 && (
                  <div class="mt-3 flex flex-wrap gap-2 text-[0.65rem]">
                    {featured_story.genres.map((tag: string) => (
                      <span class="rounded-full px-3 py-1 bg-white/10">{tag}</span>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <a
              href={`/storytime/story/${featured_story.slug || featured_story.id}`}
              class="rounded-lg brand-bg px-4 py-2 text-sm font-semibold text-white text-center hover:opacity-90 transition-opacity"
            >
              {featured_story.cta_text || 'Start Reading'}
            </a>
          </div>
        )}
      </section>

      <!-- Story Grid -->
      {stories.length > 0 && (
        <section class="mt-12 md:mt-14">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-white">Explore the universes</h2>
            <a href="/storytime" class="text-xs font-semibold uppercase tracking-[0.2em] text-neutral-200 hover:text-white">
              View all series
            </a>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            {stories.slice(0, 4).map((story: any) => (
              <article class="group rounded-3xl bg-neutral-900/30 border border-white/10 p-5 sm:p-6 backdrop-blur-xl shadow-xl flex flex-col">
                <div class="flex flex-col gap-4 sm:flex-row">
                  {story.cover_image && (
                    <a href={`/storytime/story/${story.slug}`} class="h-32 w-24 flex-shrink-0 rounded-xl overflow-hidden">
                      <img 
                        src={absoluteUrl(story.cover_image)} 
                        alt={story.title} 
                        class="h-full w-full object-cover group-hover:scale-[1.03] transition-transform duration-200"
                        loading="lazy"
                      />
                    </a>
                  )}
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-white">{story.title}</h3>
                    {story.tagline && <p class="mt-1 text-xs font-medium brand-text">{story.tagline}</p>}
                    <p class="mt-2 text-sm text-neutral-100 line-clamp-3">{story.homepage_description || story.description}</p>
                  </div>
                </div>
                <div class="mt-4 flex items-center justify-end">
                  <a
                    href={`/storytime/story/${story.slug || story.id}`}
                    class="rounded-full px-4 py-1.5 text-xs font-semibold bg-white/10 text-white group-hover:brand-bg transition-colors"
                  >
                    {story.cta_text || 'Start Reading'}
                  </a>
                </div>
              </article>
            ))}
          </div>
        </section>
      )}

      <!-- Footer -->
      <footer class="mt-12 border-t border-white/10 pt-6 text-center text-xs text-neutral-200">
        <p>© {new Date().getFullYear()} {profile.name}. All rights reserved.</p>
        <p class="mt-2 opacity-60">
          <span>Owner of this site? </span>
          <a href="/admin" class="hover:underline">Admin Login</a>
        </p>
      </footer>
    </div>
  </div>
</BaseLayout>
