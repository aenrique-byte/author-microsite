---
/**
 * Dynamic Blog Post Page
 * Generates a page for each published blog post at build time
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import { marked } from 'marked';

const API_URL = import.meta.env.API_URL || 'https://aenrique.com';

// Generate static paths for all published posts
export async function getStaticPaths() {
  const API_URL = import.meta.env.API_URL || 'https://aenrique.com';
  
  try {
    const response = await fetch(`${API_URL}/api/blog/list.php`);
    if (!response.ok) return [];
    
    const data = await response.json();
    const posts = (data.posts || data.data || []).filter((p: any) => p.status === 'published');
    
    return posts.map((post: any) => ({
      params: { slug: post.slug },
      props: { post }
    }));
  } catch (e) {
    console.warn('Could not fetch blog posts for static paths:', e);
    return [];
  }
}

interface Props {
  post: any;
}

const { post } = Astro.props;

// Fetch full post content if needed
let fullPost = post;
let authorName = 'Author';

try {
  const [postRes, authorRes] = await Promise.all([
    fetch(`${API_URL}/api/blog/get.php?slug=${post.slug}`),
    fetch(`${API_URL}/api/author/get.php`)
  ]);
  
  if (postRes.ok) {
    const data = await postRes.json();
    fullPost = data.post || data.data || post;
  }
  
  if (authorRes.ok) {
    const data = await authorRes.json();
    authorName = data.profile?.name || authorName;
  }
} catch (e) {
  console.warn('Could not fetch post details:', e);
}

// Helper to ensure image URLs are absolute
function absoluteUrl(url: string | undefined): string {
  if (!url) return '';
  if (url.startsWith('http://') || url.startsWith('https://')) return url;
  if (url.startsWith('/')) return `${API_URL}${url}`;
  return `${API_URL}/${url}`;
}

// Format date
function formatDate(dateStr: string): string {
  try {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  } catch {
    return dateStr;
  }
}

// Render markdown content
const htmlContent = marked(fullPost.content || fullPost.body || '');
---

<BaseLayout 
  title={`${fullPost.title} | ${authorName}`}
  description={fullPost.excerpt || fullPost.content?.substring(0, 160)?.replace(/[#*_~`]/g, '')}
  image={fullPost.featured_image}
  type="article"
>
  <div class="min-h-screen bg-neutral-950">
    <!-- Header -->
    <header class="border-b border-white/10">
      <div class="max-w-4xl mx-auto px-4 py-6 flex items-center justify-between">
        <a href="/blog" class="text-sm font-semibold brand-text">← All Posts</a>
        <div class="w-16"></div>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
      <article>
        <!-- Featured Image -->
        {fullPost.featured_image && (
          <div class="rounded-2xl overflow-hidden mb-8 aspect-video">
            <img 
              src={absoluteUrl(fullPost.featured_image)}
              alt={fullPost.title}
              class="w-full h-full object-cover"
            />
          </div>
        )}

        <!-- Post Header -->
        <header class="mb-8">
          <div class="flex items-center gap-3 text-sm text-neutral-400 mb-4">
            <time datetime={fullPost.published_at || fullPost.created_at}>
              {formatDate(fullPost.published_at || fullPost.created_at)}
            </time>
            {fullPost.category && (
              <>
                <span>•</span>
                <span class="brand-text">{fullPost.category}</span>
              </>
            )}
            {fullPost.read_time && (
              <>
                <span>•</span>
                <span>{fullPost.read_time} min read</span>
              </>
            )}
          </div>
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">{fullPost.title}</h1>
          {fullPost.excerpt && (
            <p class="text-lg text-neutral-300">{fullPost.excerpt}</p>
          )}
          {fullPost.tags && fullPost.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mt-4">
              {fullPost.tags.map((tag: string) => (
                <span class="text-xs px-3 py-1 rounded-full bg-white/10 text-neutral-300">
                  {tag}
                </span>
              ))}
            </div>
          )}
        </header>

        <!-- Post Content -->
        <div 
          class="prose prose-lg prose-invert max-w-none
                 prose-headings:text-white 
                 prose-p:text-neutral-200 
                 prose-p:leading-relaxed
                 prose-a:brand-text
                 prose-strong:text-white
                 prose-blockquote:border-l-4 prose-blockquote:border-brand-500 prose-blockquote:text-neutral-300
                 prose-code:text-brand-400 prose-code:bg-neutral-800/50 prose-code:px-1 prose-code:rounded
                 prose-img:rounded-xl"
          set:html={htmlContent}
        />

        <!-- Post Footer -->
        <footer class="mt-12 pt-8 border-t border-white/10">
          <a 
            href="/blog"
            class="inline-block px-6 py-3 rounded-lg border border-white/20 text-white hover:bg-white/10 transition-colors"
          >
            ← Back to All Posts
          </a>
        </footer>
      </article>
    </main>
  </div>
</BaseLayout>
