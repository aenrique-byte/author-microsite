---
/**
 * Blog Listing Page
 * Shows all published blog posts
 */
import BaseLayout from '../../layouts/BaseLayout.astro';

const API_URL = import.meta.env.API_URL || 'https://aenrique.com';

// Fetch blog posts at build time
let posts: any[] = [];
let authorName = 'Author';

try {
  const [postsRes, authorRes] = await Promise.all([
    fetch(`${API_URL}/api/blog/list.php`),
    fetch(`${API_URL}/api/author/get.php`)
  ]);
  
  if (postsRes.ok) {
    const data = await postsRes.json();
    posts = (data.posts || data.data || []).filter((p: any) => p.status === 'published');
  }
  
  if (authorRes.ok) {
    const data = await authorRes.json();
    authorName = data.profile?.name || authorName;
  }
} catch (e) {
  console.warn('Could not fetch blog posts:', e);
}

// Helper to ensure image URLs are absolute
function absoluteUrl(url: string | undefined): string {
  if (!url) return '';
  if (url.startsWith('http://') || url.startsWith('https://')) return url;
  if (url.startsWith('/')) return `${API_URL}${url}`;
  return `${API_URL}/${url}`;
}

// Format date
function formatDate(dateStr: string): string {
  try {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  } catch {
    return dateStr;
  }
}
---

<BaseLayout 
  title={`Blog | ${authorName}`}
  description={`Read blog posts and updates by ${authorName}.`}
>
  <div class="min-h-screen bg-neutral-950">
    <!-- Header -->
    <header class="border-b border-white/10">
      <div class="max-w-4xl mx-auto px-4 py-6 flex items-center justify-between">
        <a href="/" class="text-sm font-semibold brand-text">← Home</a>
        <h1 class="text-lg font-bold text-white">Blog</h1>
        <div class="w-12"></div>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
      {posts.length === 0 ? (
        <p class="text-neutral-400 text-center py-12">No blog posts yet.</p>
      ) : (
        <div class="space-y-8">
          {posts.map((post) => (
            <article class="group">
              <a href={`/blog/${post.slug}`} class="block">
                {post.featured_image && (
                  <div class="rounded-xl overflow-hidden mb-4 aspect-video">
                    <img 
                      src={absoluteUrl(post.featured_image)}
                      alt={post.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                    />
                  </div>
                )}
                <div class="flex items-center gap-3 text-xs text-neutral-400 mb-2">
                  <time datetime={post.published_at || post.created_at}>
                    {formatDate(post.published_at || post.created_at)}
                  </time>
                  {post.category && (
                    <>
                      <span>•</span>
                      <span class="brand-text">{post.category}</span>
                    </>
                  )}
                  {post.read_time && (
                    <>
                      <span>•</span>
                      <span>{post.read_time} min read</span>
                    </>
                  )}
                </div>
                <h2 class="text-xl font-bold text-white group-hover:brand-text transition-colors mb-2">
                  {post.title}
                </h2>
                {post.excerpt && (
                  <p class="text-neutral-300 line-clamp-2">{post.excerpt}</p>
                )}
                {post.tags && post.tags.length > 0 && (
                  <div class="flex flex-wrap gap-2 mt-3">
                    {post.tags.slice(0, 3).map((tag: string) => (
                      <span class="text-xs px-2 py-1 rounded-full bg-white/10 text-neutral-300">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </a>
            </article>
          ))}
        </div>
      )}
    </main>
  </div>
</BaseLayout>
