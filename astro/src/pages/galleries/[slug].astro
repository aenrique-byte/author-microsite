---
/**
 * Dynamic Gallery Page
 * Generates a page for each gallery at build time
 */
import BaseLayout from '../../layouts/BaseLayout.astro';

const API_URL = import.meta.env.API_URL || 'https://aenrique.com';

// Generate static paths for all galleries
export async function getStaticPaths() {
  const API_URL = import.meta.env.API_URL || 'https://aenrique.com';
  
  try {
    const response = await fetch(`${API_URL}/api/galleries/list.php`);
    if (!response.ok) return [];
    
    const data = await response.json();
    const galleries = (data.galleries || data.data || []).filter((g: any) => g.status !== 'draft');
    
    return galleries.map((gallery: any) => ({
      params: { slug: gallery.slug },
      props: { gallery }
    }));
  } catch (e) {
    console.warn('Could not fetch galleries for static paths:', e);
    return [];
  }
}

interface Props {
  gallery: any;
}

const { gallery } = Astro.props;

// Fetch images for this gallery
let images: any[] = [];
let authorName = 'Author';

try {
  const [imagesRes, authorRes] = await Promise.all([
    fetch(`${API_URL}/api/images/gallery-list.php?gallery_id=${gallery.id}`),
    fetch(`${API_URL}/api/author/get.php`)
  ]);
  
  if (imagesRes.ok) {
    const data = await imagesRes.json();
    images = data.images || data.data || [];
  }
  
  if (authorRes.ok) {
    const data = await authorRes.json();
    authorName = data.profile?.name || authorName;
  }
} catch (e) {
  console.warn('Could not fetch images:', e);
}

// Helper to ensure image URLs are absolute
function absoluteUrl(url: string | undefined): string {
  if (!url) return '';
  if (url.startsWith('http://') || url.startsWith('https://')) return url;
  if (url.startsWith('/')) return `${API_URL}${url}`;
  return `${API_URL}/${url}`;
}
---

<BaseLayout 
  title={`${gallery.title} | ${authorName}`}
  description={gallery.description || `Gallery: ${gallery.title}`}
  image={gallery.hero_image || gallery.hero_thumb}
  type="article"
>
  <div class="min-h-screen bg-neutral-950">
    <!-- Header -->
    <header class="border-b border-white/10">
      <div class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
        <a href="/galleries" class="text-sm font-semibold brand-text">‚Üê All Galleries</a>
        <h1 class="text-lg font-bold text-white">{gallery.title}</h1>
        <div class="w-16"></div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <!-- Gallery Info -->
      <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-white mb-2">{gallery.title}</h1>
        {gallery.description && (
          <p class="text-neutral-300 max-w-2xl mx-auto">{gallery.description}</p>
        )}
        <div class="flex items-center justify-center gap-4 mt-4 text-sm text-neutral-400">
          <span>üì∑ {images.length} images</span>
          <span>‚ù§Ô∏è {gallery.like_count || 0} likes</span>
          <span>üí¨ {gallery.comment_count || 0} comments</span>
        </div>
      </div>

      <!-- Images Grid -->
      {images.length === 0 ? (
        <p class="text-neutral-400 text-center py-12">No images in this gallery yet.</p>
      ) : (
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {images.map((image: any, index: number) => {
            const imageUrl = image.thumb_url || image.url || image.file_url;
            const fullUrl = image.url || image.file_url;
            
            return (
              <a 
                href={absoluteUrl(fullUrl)}
                target="_blank"
                rel="noopener noreferrer"
                class="group relative rounded-xl overflow-hidden bg-neutral-800 aspect-square"
              >
                <img
                  src={absoluteUrl(imageUrl)}
                  alt={image.title || `Image ${index + 1}`}
                  class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
                {image.title && (
                  <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                    <p class="text-sm text-white font-medium truncate">{image.title}</p>
                  </div>
                )}
              </a>
            );
          })}
        </div>
      )}

      <!-- Back Link -->
      <div class="mt-12 text-center">
        <a 
          href="/galleries"
          class="inline-block px-6 py-3 rounded-lg border border-white/20 text-white hover:bg-white/10 transition-colors"
        >
          ‚Üê Back to All Galleries
        </a>
      </div>
    </main>
  </div>
</BaseLayout>
